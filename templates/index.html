<!DOCTYPE html>

<html>
    <head>
        <title>Options Tracer</title>
        <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>

        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>

        <style type="text/css">
            .container {
                max-width: 90%;
            }
        </style>
    </head>
    <body onload="loadChecks()">
        <div class="container">
            <h1>Options Tracker</h1>
            <div class="row">
                <form method=POST enctype=multipart/form-data action="{{ url_for('loadsite') }}">
                    <input type=file name=csvtype>
                    <input type="submit" value="Send File">
                </form>
            </div>
            <br>
            <br>
            {% if params %}
            <button data-toggle="collapse" data-target="#collapsed">Collapse</button>
            <div class="row">
                <div class="col-6">
                    <form method="POST" action="{{ url_for('test') }}">
                        <div style="display:none;">
                            <textarea cols="12" name="showVals" id="showVals" readonly></textarea>
                        </div>
                        <input type="submit" value="Plot Graph">
                    </form>
                    <table id="checkAll">
                        <tr>
                            <td>Check All?</td>
                            <td>
                                <input type="checkbox" onchange="checkAll(this)" id="allbox" name="allbox" value="allpick">
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            <div id="collapsed" class="row">
                <div class="col-6">
                    <input type="text" id="myInput" onkeyup="parseTable()" onfocus="showAll(this)" onblur="hideInfo(this)" placeholder="Enter a symbol..">
                </div>
                <table class="table" id="symboltable">
                    <tbody id="table-body")>
                        {% for j in range(appsymbollength) %}
                        <tr class="d-flex">
                            {% for k in range(6) %}
                                {% if symbols[6*j+k] %}

                                    <td name="{{ symbols[6*j+k] }}namecell" class="col-1">
                                        {{ symbols[6*j+k] }}
                                    </td>
                                    <td name="{{ symbols[6*j+k] }}boxcell" class="col-1">
                                        <input type="checkbox" onchange="showPicked(this)" id="{{ symbols[6*j+k] }}" name="symbolcheckbox" value="pick{{ symbols[6*j+k] }}">
                                    </td>

                                {% endif %}
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
                {% if plot1 %}
                <select name="params2" id="params1" onchange="plotNew(this)">
                    {% for param in params %}
                    <option value="{{ param }}">{{ param }}</option>
                    {% endfor %}
                </select>
                <div class="chart" id="graph1">
                    <script>
                        var graphs = {{plot1 | safe}};
                        Plotly.plot('graph1',graphs,{});
                    </script>
                </div>
                {% endif %}
                {% if plot2 %}
                <select name="params2" id="params2" onchange="plotNew(this)">
                    {% for param in params %}
                    <option value="{{ param }}">{{ param }}</option>
                    {% endfor %}
                </select>
                <div class="chart" id="graph2">
                    <script>
                        var graphs = {{plot2 | safe}};
                        Plotly.plot('graph2',graphs,{});
                    </script>
                </div>
                {% endif %}
            </div>
        <script>

        function parseTable() {
            // Declare variables
            var input, table, tr, td, i, j, txtValue;
            input = document.getElementById("myInput").value;
            table = document.getElementById("symboltable");
            tr = table.getElementsByTagName("tr");

            for (i = 0; i < tr.length; i++) {
                td = tr[i].getElementsByTagName("td");
                console.log(td);
                if(td) {
                    for(j = 0; j < td.length; j=j+2) {
                        txtValue = td[j].textContent || td[j].innerText;
                        if (txtValue.toUpperCase().indexOf(input) > -1) {
                            td[j].className = "col-1";
                            td[j+1].className = "col-1";
                        } else {
                            td[j].className = "d-none";
                            td[j+1].className = "d-none";
                        }
                    }
                }
            }
        }

        function hideInfo(source) {
            var table, tr;
            table = document.getElementById("symboltable");
            tr = table.getElementsByTagName("tr");
            if (source.value === "") {
                for (i = 0; i < 5; i++) {
                    tr[i].className = "d-flex";
                }
                for (i = 6; i < tr.length; i++) {
                    tr[i].className = "d-none";
                }
            }
        }

        function showAll(source) {
            var table, tr;
            table = document.getElementById("symboltable");
            tr = table.getElementsByTagName("tr");
            for (i = 0; i < tr.length; i++) {
                tr[i].style.display = "";
            }
        }

        function showPicked(source) {
            var items = document.getElementById("showVals").innerHTML.split("\n ");
            localStorage.setItem(source.id, source.checked);
            if (source.checked) {
                var text = document.createTextNode(source.id);
                if(items.indexOf(source.id) == -1) {
                    items.push(source.id);
                    console.log("added " + source.id);
                }
            } else {
                var text = document.createTextNode(source.id);
                if(items.indexOf(source.id) != -1) {
                    items.splice(items.indexOf(source.id), 1);
                    console.log("deleted " + source.id);
                }
            }
            document.getElementById("showVals").innerHTML = items.join("\n ");
        }

        function checkAll(source) {
            checkboxes = document.getElementsByName('symbolcheckbox');

            for (i = 0; i < checkboxes.length; i++) {
                checkboxes[i].checked = source.checked;
                showPicked(checkboxes[i]);
            }
        }

        function loadChecks() {
            checkboxes = document.getElementsByName('symbolcheckbox');
            for(i = 0; i < checkboxes.length; i++) {
                checkboxes[i].checked = localStorage.getItem(checkboxes[i].id) === 'true' ? true:false;
                if(checkboxes[i].checked) {
                    showPicked(checkboxes[i]);
                }
            }
        }

        function plotNew(source) {
            var items = document.getElementById("showVals").innerHTML.split("\n ");
            console.log(items);
            var parma = source.value;
            var appender = source.id.substring(6);
            req = $.ajax({
                url: '/swapgraph',
                type: 'POST',
                data: {
                    items: JSON.stringify(items),
                    parma: parma,
                    graph: appender
                }
            })
            req.done(function (response) {
                $("#graph" + appender).fadeOut(100).fadeIn(100);
                graphs = JSON.parse(response);
                console.log(graphs.data);
                console.log(graphs.layout);
                if (appender === "1") {
                    console.log("its one");
                    Plotly.react('graph1', graphs.data, graphs.layout);
                }
                if (appender === "2") {
                    console.log("its two");
                    Plotly.react('graph2', graphs.data, graphs.layout);
                }
            });
        }


        </script>

    </body>
</html>